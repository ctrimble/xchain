<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at Apr 7, 2013
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Christian Trimble
Jason Rose" />
    <meta name="Date-Revision-yyyymmdd" content="20130407" />
    <meta http-equiv="Content-Language" content="en" />
    <title>XChain Framework - Creating Commands</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />

      
    <script type="text/javascript" src="../js/apache-maven-fluido-1.3.0.min.js"></script>

    
            </head>
        <body class="topBarDisabled">
          
        
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>XChain Framework : Core Module</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
            
                  <li id="publishDate">Last Published: Apr 07 2013</li>
                  <li class="divider">|</li> <li id="projectVersion">Version: 0.5.0-SNAPSHOT</li>
                          <li class="divider">|</li>             <li class="">
                    <a href="http://xiantrimble.com/xchain" class="externalLink" title="XChain Framework">
        XChain Framework</a>
        </li>
      <li class="divider ">/</li>
            <li class="">
                    <a href="../index.html" title="Core Module">
        Core Module</a>
        </li>
      <li class="divider ">/</li>
        <li class="">Creating Commands</li>
                
                
            
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
            
                <ul class="nav nav-list">
                    <li class="nav-header">Core Module</li>
                                
      <li>
    
                          <a href="../index.html" title="Introduction">
          <i class="none"></i>
        Introduction</a>
            </li>
                              <li class="nav-header">Documentation</li>
                                
      <li>
    
                          <a href="../guides/command-definition.html" title="Command Definition">
          <i class="none"></i>
        Command Definition</a>
            </li>
                  
      <li>
    
                          <a href="../guides/attribute-definition.html" title="Attribute Defintiions">
          <i class="none"></i>
        Attribute Defintiions</a>
            </li>
                  
      <li>
    
                          <a href="../guides/lifecycle.html" title="Lifecycle">
          <i class="none"></i>
        Lifecycle</a>
            </li>
                  
      <li class="active">
    
            <a href="#"><i class="none"></i>SAX Pipelines</a>
          </li>
                              <li class="nav-header">Namespaces</li>
                                
      <li>
    
                          <a href="../namespaces/core.html" title="Core">
          <i class="none"></i>
        Core</a>
            </li>
                  
      <li>
    
                          <a href="../namespaces/sax.html" title="SAX">
          <i class="none"></i>
        SAX</a>
            </li>
                  
      <li>
    
                          <a href="../namespaces/jsl.html" title="JSL">
          <i class="none"></i>
        JSL</a>
            </li>
                  
      <li>
    
                          <a href="../namespaces/csv.html" title="CSV">
          <i class="none"></i>
        CSV</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                                                                                                                              
      <li>
    
                          <a href="../project-info.html" title="Project Information">
          <i class="icon-chevron-right"></i>
        Project Information</a>
                  </li>
                                                                                                                                                                                                                    
      <li>
    
                          <a href="../project-reports.html" title="Project Reports">
          <i class="icon-chevron-right"></i>
        Project Reports</a>
                  </li>
            </ul>
                
            
                
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <!--  --><!-- Copyright 2011 meltmedia --><!--  --><!-- Licensed under the Apache License, Version 2.0 (the "License"); --><!-- you may not use this file except in compliance with the License. --><!-- You may obtain a copy of the License at --><!--  --><!-- http://www.apache.org/licenses/LICENSE-2.0 --><!--  --><!-- Unless required by applicable law or agreed to in writing, software --><!-- distributed under the License is distributed on an "AS IS" BASIS, --><!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. --><!-- See the License for the specific language governing permissions and --><!-- limitations under the License. --><!--  --><!-- NOTE: For help with the syntax of this file, see: --><!-- http://maven.apache.org/doxia/references/apt-format.html --><div class="section"><h2><a name="Creating_Commands_That_Output_SAX_Events">Creating Commands That Output SAX Events</a></h2><div class="section"><h3>Overview<a name="Overview"></a></h3><p>In this guide we will create two XChain commands that will output html select and option elements. This example assumes that the reader understands the SAX event model and is familar with the org.xml.sax.* classes. If you are not, those interfaces can be found in the Java SE 1.4+ javadocs and information about the SAX event model can be found at http://www.saxproject.org/.</p><p>This example will define a set of elements that look like this:</p><div class="source"><pre class="prettyprint">  &lt;xhtml:select id=&quot;id&quot; name=&quot;number&quot;&gt;
    &lt;xhtml:option value=&quot;&quot;&gt;--select one--&lt;/xhtml:option&gt;
    &lt;xhtml:option value=&quot;one&quot;&gt;One&lt;/xhtml:option&gt;
    &lt;xhtml:option value=&quot;two&quot;&gt;Two&lt;/xhtml:option&gt;
    &lt;xhtml:option value=&quot;three&quot;&gt;Three&lt;/xhtml:option&gt;
  &lt;/xhtml:select&gt;</pre></div></div><div class="section"><h3>Creating the package for the example.<a name="Creating_the_package_for_the_example."></a></h3><p>First, we need a package for our classes if we do not already have one. To do this, we will create a directory for the package and then place a package-info.java file in the package, that defines the namespace for our commands.</p><div class="source"><pre class="prettyprint">/**
  * &lt;p&gt;The Guide command package.&lt;/p&gt;
  */
@org.xchain.annotations.Namespace(uri=&quot;http://www.xchain.org/guide/xhtml&quot;)
package org.xchain.example.namespaces.xhtml;</pre></div></div><div class="section"><h3>Creating the select command.<a name="Creating_the_select_command."></a></h3><p>Next, we need to create an abstract class that implements the org.xchain.Chain interface. This will allow other xchains to be nested inside of our select class.</p><p>The class will also need access to a content handler for the output nodes. We will do this by asking the org.xchain.namespaces.sax.Pipeline command for the configuration tied to the current thread. This configuration object provides access to the org.xml.sax.ContentHandler object being used by the current execution. Passing an html fragment to this handler will allow us to write an html fragment to the output using sax events.</p><p>This is the code to access the content handler:</p><div class="source"><pre class="prettyprint">  protected CommandHandler getContentHandler() {
    return ((CommandXmlReader) PipelineCommand.getPipelineConfig().getXmlReader()).getCommandHandler();
  }</pre></div><p>The complete code for the &lt;xhtml:select/&gt; element:</p><div class="source"><pre class="prettyprint">package org.xchain.example.namespaces.xhtml;

import javax.servlet.http.HttpServletRequest;
import javax.xml.namespace.QName;
import org.apache.commons.jxpath.JXPathContext;
import org.xchain.Filter;
import org.xchain.impl.ChainImpl;
import org.xchain.annotations.Element;
import org.xchain.annotations.Attribute;
import org.xchain.annotations.AttributeType;
import org.xchain.annotations.PrefixMapping;
import org.xchain.framework.jxpath.Scope;
import org.xchain.framework.jxpath.ScopedQNameVariables;
import org.xchain.framework.sax.CommandXmlReader;
import org.xchain.framework.sax.CommandHandler;
import org.xchain.namespaces.sax.PipelineCommand;
import org.xml.sax.ContentHandler;
import org.xml.sax.Attributes;
import org.xml.sax.SAXException;
import org.xml.sax.helpers.AttributesImpl;

@Element(localName=&quot;select&quot;)
public abstract class SelectCommand
  extends ChainImpl
  implements Filter
{
  public static final QName SELECTED_VARIABLE_NAME = QName.valueOf(&quot;{http://www.xchain.org/guide/xhtml}selected&quot;);
  public static final String SELECT_LOCAL_NAME = &quot;select&quot;;
  public static final String ID_LOCAL_NAME = &quot;id&quot;;
  public static final String NAME_LOCAL_NAME = &quot;name&quot;;
  public static final String XHTML_NAMESPACE = &quot;http://www.w3.org/1999/xhtml&quot;;

  @Attribute(
    localName = &quot;id&quot;,
    type = AttributeType.ATTRIBUTE_VALUE_TEMPLATE
  ) 
  public abstract String getId(JXPathContext context);
  public abstract boolean hasId();

  @Attribute(
    localName = &quot;name&quot;,
    type = AttributeType.ATTRIBUTE_VALUE_TEMPLATE
  )
  public abstract String getName(JXPathContext context);

  @Attribute(
    localName = &quot;request&quot;,
    type = AttributeType.JXPATH_VALUE,
    defaultValue = &quot;$servlet:request&quot;,
    defaultPrefixMappings = {@PrefixMapping(uri=&quot;http://www.xchain.org/servlet/1.0&quot;, prefix=&quot;servlet&quot;)}
  )
  public abstract HttpServletRequest getRequest( JXPathContext context );

  public boolean execute(JXPathContext context)
    throws Exception
  {
    // get the request and the name from the context.
    HttpServletRequest request = getRequest(context);
    String name = getName(context);

    // get the original value of the name.
    String currentValue = request.getParameter(name);

    // get the xhtml prefix and make sure that there is a mapping for it.
    String xhtmlPrefix = context.getPrefix(XHTML_NAMESPACE);
    if( xhtmlPrefix == null ) {
      throw new IllegalStateException(&quot;There is no mapping defined for &quot;+XHTML_NAMESPACE);
    }

    // create the attributes for the element we are going to output.
    AttributesImpl attributes = new AttributesImpl();
    if( hasId() ) {
      attributes.addAttribute(&quot;&quot;, ID_LOCAL_NAME, ID_LOCAL_NAME, &quot;CDATA&quot;, getId(context));
    }
    attributes.addAttribute(&quot;&quot;, NAME_LOCAL_NAME, NAME_LOCAL_NAME, &quot;CDATA&quot;, getName(context));

    ((ScopedQNameVariables)context.getVariables()).declareVariable(SELECTED_VARIABLE_NAME, currentValue, Scope.execution);
    ContentHandler handler = getContentHandler();
    handler.startElement(XHTML_NAMESPACE, SELECT_LOCAL_NAME, qNameString(xhtmlPrefix, SELECT_LOCAL_NAME), attributes);

    boolean result = false;
    Exception exception = null;

    // execute the children and catch any exceptions.
    try {
      result = super.execute(context);
    }
    catch (Exception e) {
      exception = e;
    }

    // if there was not an exception, or the exception is not a sax exception, then we need to finish the output.
    if( exception == null || !(exception instanceof SAXException) ) {
      handler.endElement(XHTML_NAMESPACE, SELECT_LOCAL_NAME, qNameString(xhtmlPrefix, SELECT_LOCAL_NAME));
    }

    // rethrow the exception.
    if( exception != null ) {
      throw exception;
    }
    return result;
  }

  public boolean postProcess( JXPathContext context, Exception e )
  {
    ((ScopedQNameVariables)context).undeclareVariable(SELECTED_VARIABLE_NAME);
    return false;
  }

  protected CommandHandler getContentHandler()
  {
    return ((CommandXmlReader) PipelineCommand.getPipelineConfig().getXmlReader()).getCommandHandler();
  }

  protected String qNameString( String prefix, String localName )
  {
    return (prefix == null || prefix.equals(&quot;&quot;)) ? localName : prefix+&quot;:&quot;+localName;
  }
}</pre></div></div><div class="section"><h3>Creating the option command.<a name="Creating_the_option_command."></a></h3><p>Now that the select command is defined, we need an option command. This command will look at the selected variable set by the select command and create the proper option attributes in the output document.</p><div class="source"><pre class="prettyprint">package org.xchain.example.namespaces.xhtml;

import org.apache.commons.jxpath.JXPathContext;
import org.xchain.impl.ChainImpl;
import org.xchain.annotations.Attribute;
import org.xchain.annotations.AttributeType;
import org.xchain.annotations.Element;
import org.xchain.framework.jxpath.Scope;
import org.xchain.framework.jxpath.ScopedQNameVariables;
import org.xchain.framework.sax.CommandXmlReader;
import org.xchain.framework.sax.CommandHandler;
import org.xchain.namespaces.sax.PipelineCommand;
import org.xml.sax.Attributes;
import org.xml.sax.ContentHandler;
import org.xml.sax.SAXException;
import org.xml.sax.helpers.AttributesImpl;

@Element(localName=&quot;option&quot;)
public abstract class OptionCommand
  extends ChainImpl
{
  public static final String OPTION_LOCAL_NAME = &quot;option&quot;;
  public static final String SELECTED_LOCAL_NAME = &quot;selected&quot;;
  public static final String SELECTED_VALUE = &quot;selected&quot;;
  public static final String VALUE_LOCAL_NAME = &quot;value&quot;;
  public static final String XHTML_NAMESPACE = &quot;http://www.w3.org/1999/xhtml&quot;;


  @Attribute(localName = &quot;value&quot;, type = AttributeType.ATTRIBUTE_VALUE_TEMPLATE)
  public abstract String getValue(JXPathContext context);

  public boolean execute(JXPathContext context)
    throws Exception
  {
    String value = getValue(context);
    String currentValue = (String)((ScopedQNameVariables) context.getVariables()).getVariable(SelectCommand.SELECTED_VARIABLE_NAME, Scope.execution);

    // get the xhtml prefix and make sure that there is a mapping for it.
    String xhtmlPrefix = context.getPrefix(XHTML_NAMESPACE);
    if( xhtmlPrefix == null ) {
      throw new IllegalStateException(&quot;There is no mapping defined for &quot;+XHTML_NAMESPACE);
    }

    AttributesImpl attributes = new AttributesImpl();
    if( value != null ) {
      attributes.addAttribute(&quot;&quot;, VALUE_LOCAL_NAME, VALUE_LOCAL_NAME, &quot;CDATA&quot;, value);
    }
    if( value != null &amp;&amp; value.equals(currentValue) ) {
      attributes.addAttribute(&quot;&quot;, SELECTED_LOCAL_NAME, SELECTED_LOCAL_NAME, &quot;CDATA&quot;, SELECTED_VALUE);
    }

    ContentHandler handler = getContentHandler();
    handler.startElement(XHTML_NAMESPACE, OPTION_LOCAL_NAME, qNameString(xhtmlPrefix, OPTION_LOCAL_NAME), attributes);

    boolean result = false;
    Exception exception = null;

    try {
      result = super.execute(context);
    } catch (Exception e) {
      exception = e;
    }
    if( exception == null || !(exception instanceof SAXException) ) {
      handler.endElement(XHTML_NAMESPACE, OPTION_LOCAL_NAME, qNameString(xhtmlPrefix, OPTION_LOCAL_NAME));
    }

    if( exception != null ) {
      throw exception;
    }
    return result;
  }

  protected CommandHandler getContentHandler()
  {
    return ((CommandXmlReader) PipelineCommand.getPipelineConfig().getXmlReader()).getCommandHandler();
  }

  protected String qNameString( String prefix, String localName )
  {
    return (prefix == null || prefix.equals(&quot;&quot;)) ? localName : prefix+&quot;:&quot;+localName;
  }
}</pre></div></div><div class="section"><h3>Creating the page that uses our new commands.<a name="Creating_the_page_that_uses_our_new_commands."></a></h3><p>Finally, we need to put our page into action. For this example, we will just post back to ourself with a GET request. After submitting the form, the page should redisplay with the correct value selected in the dropdown box.</p><div class="source"><pre class="prettyprint">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;?xchain-stylesheet system-id=&quot;resource://context-class-loader/org/xchain/namespaces/servlet/xhtml.xsl&quot;?&gt;
&lt;html
  xmlns=&quot;http://www.w3.org/1999/xhtml&quot;
  xmlns:jsl=&quot;http://www.xchain.org/jsl/1.0&quot;
  xmlns:xhtml=&quot;http://www.xchain.org/guide/xhtml&quot;&gt;

  &lt;head&gt;
    &lt;title&gt;SAX Events Example&lt;/title&gt;
  &lt;/head&gt;

  &lt;body&gt;
    &lt;form method=&quot;GET&quot;&gt;
      &lt;xhtml:select name=&quot;number&quot; id=&quot;number&quot;&gt;
        &lt;xhtml:option value=&quot;&quot;&gt;- -Select A Number- -&lt;/xhtml:option&gt;
        &lt;xhtml:option value=&quot;one&quot;&gt;One&lt;/xhtml:option&gt;
        &lt;xhtml:option value=&quot;two&quot;&gt;Two&lt;/xhtml:option&gt;
        &lt;xhtml:option value=&quot;three&quot;&gt;Three&lt;/xhtml:option&gt;
      &lt;/xhtml:select&gt;
      &lt;input type=&quot;submit&quot;/&gt;
    &lt;/form&gt;
  &lt;/body&gt;

&lt;/html&gt;</pre></div></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                    2013
                      XChain Framework.
            All Rights Reserved.      
            
      </div>

        
        
                </div>
    </footer>
  </body>
</html>
